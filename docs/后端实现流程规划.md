# 后端实现流程规划

本文档规划了海浪环境模型后端系统的实现流程，按照模块化和渐进式开发的原则组织。

## 📋 实现阶段概览

### 阶段 0：基础架构搭建 ✅
- [x] 项目结构搭建
- [x] Git 仓库初始化
- [x] 基础目录与占位文件

### 阶段 1：数据模型与 Schema 定义
### 阶段 2：核心服务模块实现
### 阶段 3：API 路由与接口实现
### 阶段 4：任务管理与存储
### 阶段 5：测试与优化

---

## 🔧 阶段 1：数据模型与 Schema 定义

### 1.1 更新依赖配置
**文件**: `backend/pyproject.toml`
- 添加 `pydantic`（数据验证）
- 添加 `numpy`（数值计算）
- 添加 `uuid`（任务 ID 生成，Python 内置）

### 1.2 定义 Pydantic Schema
**文件**: `backend/app/schemas/`

#### 1.2.1 基础 Schema (`schemas/base.py`)
- `Region`: 区域定义（经纬度 + 深度）
- `WindConfig`: 风场配置
- `SpectrumConfig`: 波浪谱配置
- `DiscretizationConfig`: 离散化配置
- `TimeConfig`: 时间配置

#### 1.2.2 请求/响应 Schema (`schemas/api.py`)
- `AreaSimulationRequest`: 区域模拟请求
- `AreaSimulationResponse`: 区域模拟响应
- `SimulationFramesResponse`: 模拟结果响应
- `PointQueryRequest`: 单点查询请求
- `PointQueryResponse`: 单点查询响应
- `ErrorResponse`: 错误响应

#### 1.2.3 数据 Schema (`schemas/data.py`)
- `WavePoint`: 海浪点数据
- `SimulationFrame`: 模拟帧数据
- `SimulationStatus`: 任务状态枚举

### 1.3 定义内部数据模型
**文件**: `backend/app/models/`

#### 1.3.1 网格模型 (`models/grid.py`)
- `GridPoint`: 网格点（x, y, lon, lat）
- `WaveGrid`: 海浪高度网格（时间序列）

#### 1.3.2 模拟任务模型 (`models/simulation.py`)
- `SimulationTask`: 模拟任务（ID、状态、配置、结果）

#### 1.3.3 风场模型 (`models/wind.py`)
- `WindField`: 风场状态（风速、风向）

#### 1.3.4 波浪谱模型 (`models/spectrum.py`)
- `WaveSpectrum`: 波浪谱参数（频率、方向、振幅）

---

## 🌊 阶段 2：核心服务模块实现

### 2.1 工具函数模块
**文件**: `backend/app/utils/`

#### 2.1.1 坐标转换 (`utils/coordinate.py`)
- `lonlat_to_xy(lon, lat, origin_lon, origin_lat)`: 经纬度转本地平面坐标
- `xy_to_lonlat(x, y, origin_lon, origin_lat)`: 本地坐标转经纬度
- `create_grid(region, dx, dy, max_points)`: 创建离散网格

#### 2.1.2 数值工具 (`utils/numerical.py`)
- `bilinear_interpolation(x, y, grid)`: 双线性插值
- `linear_interpolation(t, t1, v1, t2, v2)`: 线性插值（时间）

### 2.2 风场模型服务
**文件**: `backend/app/services/wind.py`

#### 功能
- `create_wind_field(config: WindConfig) -> WindField`
  - 创建固定风场（风速、风向）
  - 返回风场状态对象

#### 实现要点
- 当前版本：固定风场（风速、风向不变）
- 后续扩展：时间变化、空间变化风场

### 2.3 波浪谱模型服务
**文件**: `backend/app/services/spectrum.py`

#### 功能
- `generate_spectrum(wind: WindField, config: SpectrumConfig) -> WaveSpectrum`
  - 根据风场生成波浪谱
  - 支持 Pierson-Moskowitz (PM) 光谱
  - 后续支持 JONSWAP

#### Pierson-Moskowitz 光谱公式
```
S(ω) = (α * g²) / (ω⁵) * exp(-β * (ωₚ/ω)⁴)
```
其中：
- `α = 0.0081`
- `β = 0.74`
- `ωₚ = 2π / Tp`（峰值角频率）
- `g` 为重力加速度

#### 实现要点
- 频率范围：0.1 ~ 2.0 Hz（可配置）
- 方向分布：主浪向 + 方向扩散（余弦分布）
- 生成波成分列表（频率 × 方向 × 振幅 × 相位）

### 2.4 区域模拟服务
**文件**: `backend/app/services/simulation.py`

#### 功能
- `initialize_wave_field(spectrum: WaveSpectrum, grid: Grid) -> WaveGrid`
  - 初始化 t=0 时刻的海浪场
  - 使用叠加法：`η(x,y,t) = Σ Aᵢ * cos(kᵢ·r - ωᵢt + φᵢ)`
  - 振幅由谱控制，相位随机

- `advance_wave_field(wave_grid: WaveGrid, dt: float) -> WaveGrid`
  - 时间步进：推进一个时间步长（dt）
  - 更新所有网格点的海浪高度

- `simulate_area(region, wind_config, spectrum_config, discretization, time_config) -> List[SimulationFrame]`
  - 完整区域模拟流程
  - 返回所有时间帧的结果

#### 实现流程
1. 创建网格（经纬度 → 本地坐标）
2. 生成风场
3. 生成波浪谱
4. 初始化 t=0 海浪场
5. 循环时间步进（t = 0, dt, 2*dt, ..., T_total）
6. 每步生成 SimulationFrame

### 2.5 插值服务
**文件**: `backend/app/services/interpolation.py`

#### 功能
- `query_point(simulation_id: str, lon: float, lat: float, time: float) -> float`
  - 空间插值：双线性插值
  - 时间插值：线性插值（或取最近帧）
  - 返回海浪高度

#### 实现要点
- 找到包含该点的网格单元
- 空间：双线性插值（4 个网格点）
- 时间：找到相邻两帧，线性插值

---

## 🌐 阶段 3：API 路由与接口实现

### 3.1 API 路由模块
**文件**: `backend/app/api/`

#### 3.1.1 路由主文件 (`api/router.py`)
- 创建 FastAPI 路由
- 挂载子路由

#### 3.1.2 模拟路由 (`api/simulation.py`)
- `POST /simulate/area`: 创建区域模拟任务
- `GET /simulation/{simulationId}/frames`: 获取模拟结果

#### 3.1.3 查询路由 (`api/query.py`)
- `POST /query/point`: 单点查询

### 3.2 任务管理
**文件**: `backend/app/core/`

#### 3.2.1 任务存储 (`core/storage.py`)
- 内存存储：`Dict[str, SimulationTask]`
- 后续可扩展为数据库

#### 3.2.2 任务管理器 (`core/task_manager.py`)
- `create_simulation_task(...) -> str`: 创建任务，返回 ID
- `get_simulation_task(id: str) -> SimulationTask`: 获取任务
- `update_task_status(id: str, status: SimulationStatus)`: 更新状态

### 3.3 应用主文件更新
**文件**: `backend/app/main.py`
- 挂载 API 路由
- 配置 CORS（如果需要）
- 添加异常处理

---

## 💾 阶段 4：任务管理与存储

### 4.1 任务状态管理
- `pending`: 任务创建，等待执行
- `running`: 正在计算
- `completed`: 计算完成
- `failed`: 计算失败

### 4.2 异步任务处理（可选）
- 使用 `asyncio` 或 `BackgroundTasks`（FastAPI）
- 大区域模拟可异步执行

### 4.3 结果缓存
- 模拟结果存储在内存中
- 支持按时间范围查询

---

## 🧪 阶段 5：测试与优化

### 5.1 单元测试
**文件**: `tests/backend/`
- 测试风场模型
- 测试波浪谱模型
- 测试插值函数
- 测试坐标转换

### 5.2 API 测试
- 使用 `httpx` 测试 API 端点
- 测试请求/响应格式

### 5.3 性能优化
- 数值计算优化（NumPy 向量化）
- 内存优化（大区域处理）
- 并发处理（多任务）

---

## 📝 实现顺序建议

### 第一轮：基础功能（MVP）
1. ✅ 阶段 0：基础架构
2. **阶段 1.1-1.2**：Schema 定义
3. **阶段 2.1**：工具函数（坐标转换、插值）
4. **阶段 2.2**：风场模型（固定风场）
5. **阶段 2.3**：波浪谱模型（PM 光谱，简化版）
6. **阶段 2.4**：区域模拟（简化版，单帧）
7. **阶段 3.1-3.2**：API 路由（同步执行）
8. **阶段 4.1**：任务管理（内存存储）

### 第二轮：完整功能
9. **阶段 2.4**：完整时间序列模拟
10. **阶段 2.5**：插值服务
11. **阶段 3.3**：完善 API
12. **阶段 5.1**：单元测试

### 第三轮：优化与扩展
13. **阶段 4.2**：异步任务处理
14. **阶段 5.2-5.3**：性能优化
15. 扩展：JONSWAP 光谱、变化风场等

---

## 🔍 关键技术点

### 1. 海浪场生成（叠加法）
```python
# 伪代码
for each wave component (ω, θ, A, φ):
    k = (2π/λ) * (cos(θ), sin(θ))  # 波数向量
    η += A * cos(k·r - ω*t + φ)
```

### 2. 双线性插值
```python
# 在网格单元 (x1,y1) - (x2,y2) 中插值点 (x,y)
f(x,y) = f(x1,y1)*(1-α)*(1-β) + 
         f(x2,y1)*α*(1-β) + 
         f(x1,y2)*(1-α)*β + 
         f(x2,y2)*α*β
```

### 3. 坐标转换
- 使用墨卡托投影或简单平面近似
- 小区域可用平面坐标（误差可接受）

---

## 📚 参考资料

- Pierson-Moskowitz 光谱模型
- 海浪数值模拟方法
- FastAPI 文档
- NumPy 数值计算

---

**下一步**：开始实现阶段 1（Schema 定义）


