# **时变海浪环境模型系统 - 需求文档（V1.0）**

## **文档信息**

* 文档版本：V1.1
* Applicable Version：V1.1
* 文档类型：需求说明（PRD + 技术需求综合）
* 作者：——
* 更新日期：2024-12-19

## **更新历史**

* **V1.1** (2024-12-19)
  * 更新接口说明：获取区域模拟结果接口改为单时刻查询
  * 支持 `time=-1` 获取最新帧
  * `T_total` 支持 `-1` 表示无限制运行
  * 添加缓存保留时间（`cache_retention_time`）参数说明
  
* **V1.0** (初始版本)
  * 初始需求文档

---

## **快速导航**

* **[1. 概述](#1-概述)** - 系统简介和应用场景
* **[2. 系统整体架构](#2-系统整体架构)** - 架构原则、模块组成、技术栈
* **[3. 时间逻辑与仿真控制](#3-时间逻辑与仿真控制)** - 时间步长、仿真控制逻辑
* **[4. 后端核心功能需求](#4-后端核心功能需求)** - 区域模拟、单点查询
* **[5. 前端功能需求](#5-前端功能需求)** - 可视化、查询、参数配置
* **[6. 风场模型需求](#6-风场模型需求)** - 风场模型参数说明
* **[7. 波浪谱模型需求](#7-波浪谱模型需求)** - PM/JONSWAP 谱模型参数
* **[8. 数值与离散化需求](#8-数值与离散化需求)** - 空间/时间离散化参数
* **[9. 数据格式规范](#9-数据格式规范)** - 输入输出格式规范
* **[10. 后端接口（初版草案）](#10-后端接口初版草案)** - API 接口说明
* **[11. 后续规划](#11-后续规划非本版本实现)** - 未来功能规划

---

# **1. 概述**

本系统旨在实现一个**时变海浪环境模型**，支持对指定区域内的海浪高度进行**模拟、查询与可视化展示**。系统采用**前后端分离架构**，后端负责海浪物理模型模拟与数据服务，前端负责参数配置、区域显示与动态渲染。

系统可用于：海上仿真系统、可视化演示、路径规划评估、无人系统模拟等场景。

---

# **2. 系统整体架构**

## **2.1 架构原则**

* **前后端分离**，降低耦合，提升拓展能力
* 后端提供统一 JSON API
* 前端负责展示、交互和参数管理
* 模型可扩展：风场模型、波浪谱模型可后续替换或升级

## **2.2 模块组成**

| 模块            | 主要职责                    |
| ------------- | ----------------------- |
| 后端服务（FastAPI） | 海浪模拟、区域计算、数据输出、点查询、参数管理 |
| 前端系统（Streamlit） | 区域可视化、参数配置、渲染控制、单点查询    |
| 风场模型模块        | 生成风速/风向，供谱模型使用          |
| 波浪谱模型模块       | 根据风场生成波浪谱参数，输出波成分       |
| 海浪场生成模块       | 根据谱叠加生成海浪高度场            |
| 插值模块          | 提供单点查询（双线性插值 + 时间插值）    |

## **2.3 技术栈**

### **后端技术栈**
- **框架**: FastAPI
- **语言**: Python 3.8
- **数据验证**: Pydantic
- **ASGI 服务器**: Uvicorn
- **数值计算**: NumPy

### **前端技术栈**
- **框架**: Streamlit
- **语言**: Python 3.8
- **可视化库**: Plotly / Matplotlib / Folium
- **HTTP 客户端**: httpx

### **通信方式**
- 前后端通过 HTTP REST API 通信
- 数据格式：JSON
- 后端服务地址：`http://localhost:8000`
- 前端服务地址：`http://localhost:8501`

---

# **3. 时间逻辑与仿真控制**

* 系统以**统一后端时间轴**进行仿真。
* `t = 0` 表示初始海况（初始风场 + 初始海浪场）。
* 后端计算时间步长 `dt_backend`：

  * 默认值：**200 ms**
  * 可配置
* 前端渲染时间步长 `dt_render`：

  * 与后端不同
  * 防止渲染卡顿
* 后端每隔一个 `dt_backend` 生成一帧海浪场，并可通过接口供前端按 `dt_render` 播放。
* 前端通过调用接口获取指定时刻的单帧数据，可以灵活控制播放速度和时间点。
* 使用 `time=-1` 可以获取最新帧，适用于实时监控场景。

---

# **4. 后端核心功能需求**

## **4.1 区域模拟渲染**

### 输入

* 区域（矩形区域，由对角两点描述）：

```json
{
  "lon_min": ..., "lat_min": ..., "depth_min": ...,
  "lon_max": ..., "lat_max": ..., "depth_max": ...
}
```

* 风场模型参数（见第 6 章）
* 波浪谱模型参数（见第 7 章）
* 离散化参数（dx, dy, max_points）
* 时间参数：
  * `dt_backend`：后端计算步长（秒）
  * `T_total`：总仿真时长（秒），`None` 或 `-1` 表示无限制运行
  * `cache_retention_time`：缓存保留时间（秒），可选

### 初始状态

* 初始风场：固定风场（后续可扩展）
* 初始海浪场：

  * 初始海浪可随机生成，但**必须符合波浪谱统计规律**
  * 振幅由谱控制
  * 相位随机

### 模拟过程

* 将经纬度区域映射到网格；
* 由风场 → 生成光谱 → 叠加得海浪场；
* 每 `dt_backend` 推进一次海浪模拟；
* 生成 `[t0, t1, ..., tN]` 的海浪高度场序列。

### 输出（JSON）

每个时间帧（单帧）：

```json
{
  "time": 0.2,
  "region": {...},
  "points": [
    { "lon": ..., "lat": ..., "wave_height": ... },
    ...
  ]
}
```

**注意**：接口每次只返回一个时刻的数据（单帧），如需获取多个时刻的数据，需要多次调用接口。

## **4.2 单点查询**

### 输入

```json
{
  "simulation_id": "...",
  "lon": 120.5,
  "lat": 35.2,
  "time": 0.4
}
```

### 插值逻辑

* 空间：**双线性插值**
* 时间：相邻时间帧间线性插值（必要时可先取最近一帧）

### 输出

```json
{
  "time": 0.4,
  "lon": 120.5,
  "lat": 35.2,
  "wave_height": 1.23
}
```

---

# **5. 前端功能需求**

## **5.1 区域模拟可视化**

* 显示矩形区域地图/网格
* 根据时间动态渲染海浪高度
* 支持 colorbar（颜色-浪高映射）
* 前端通过调用接口获取指定时刻的单帧数据进行渲染
* 支持使用 `time=-1` 获取最新帧，实现实时监控

## **5.2 单点查询**

* 鼠标点击地图可自动发起点查询
* 支持手动输入经纬度进行查询
* 支持指定查询时刻，或使用 `time=-1` 查询最新帧
* 显示返回的当前浪高值和实际查询时间

## **5.3 参数配置**

* 所有**可配置参数均在前端展示**
* 前端可修改并提交参数用于新一轮模拟
* 支持“基础模式”与“高级模式”

## **5.4 控制逻辑**

* **start** 按钮：根据当前参数启动仿真
* 前端按 `dt_render` 播放后端结果
* 用户可暂停/继续观看时间序列

---

# **6. 风场模型需求**

## **6.1 模型说明**

* 当前版本为：**固定风模型**
* 后续支持时间变化/空间变化风场
* 风场模型与波浪谱模型完全解耦，通过参数传递

## **6.2 可配置参数（全部前端可见）**

| 参数名                  | 默认值   | 说明        | 范围    | 显示到前端 |
| -------------------- | ----- | --------- | ----- | ----- |
| `wind_speed`         | 10.0  | 风速（m/s）   | 0–40  | 是     |
| `wind_direction_deg` | 270.0 | 风向（°，顺时针） | 0–360 | 是     |
| `reference_height_m` | 10.0  | 风速参考高度    | 固定    | 高级模式  |

> 注：
> 0° 指从北向南（可根据项目需求调整，但需保证固定定义）。

---

# **7. 波浪谱模型需求**

## **7.1 模型选择**

* 支持以下模型：

  * **Pierson-Moskowitz（PM）光谱（默认）**
  * **JONSWAP 光谱（后续版本实现）**

## **7.2 可配置参数**

### **通用参数（PM / JONSWAP 共用）**

| 参数名                       | 默认值  | 说明      | 范围               | 前端显示 |
| ------------------------- | ---- | ------- | ---------------- | ---- |
| `spectrum_model_type`     | "PM" | 光谱模型类型  | {"PM","JONSWAP"} | 是    |
| `Hs`                      | 2.0  | 显著波高（m） | 0–15             | 是    |
| `Tp`                      | 8.0  | 峰值周期（s） | 2–20             | 是    |
| `main_wave_direction_deg` | 同风向  | 主浪向     | 0–360            | 高级可选 |
| `directional_spread_deg`  | 30   | 波向扩散    | 5–90             | 高级可选 |

### **JONSWAP 专用参数（高级）**

| 参数名     | 默认值 | 说明   | 范围  | 前端显示 |
| ------- | --- | ---- | --- | ---- |
| `gamma` | 3.3 | 峰锐系数 | 1–7 | 高级模式 |

---

# **8. 数值与离散化需求**

* 输入输出使用**经纬度**；
* 中间计算过程可转换为本地平面网格 `(x, y)`；
* 空间离散参数：

  * `dx`、`dy`（单位：° 或 米），具体转换由后端定义；
  * `max_points`：空间离散点数上限；
* 时间离散参数：

  * `dt_backend`：后端计算步长（秒），必须大于 0，默认 0.2；
  * `T_total`：总仿真时长（秒）
    * `None` 或 `-1`：表示无限制持续运行（适用于长期仿真）
    * 正数：指定总仿真时长，必须大于 0
  * `cache_retention_time`：缓存保留时间（秒），用于控制内存使用
    * `None`：不限制，保留所有历史帧
    * 正数：只保留最近 N 秒的帧，超过此时间的旧帧将被自动淘汰

---

# **9. 数据格式规范**

* **所有输入输出采用 JSON 格式**
* 坐标系：经纬度（WGS84），单位：度
* 深度单位：米（m）
* 波高单位：米（m）
* 时间单位：秒（s）

---

# **10. 后端接口（初版草案）**

## **10.1 发起区域模拟**

`POST /api/simulate/area`

### 请求：

```json
{
  "region": {...},
  "wind": {...},
  "spectrum": {...},
  "discretization": {"dx":0.01,"dy":0.01,"max_points":40000},
  "time": {
    "dt_backend": 0.2,
    "T_total": 10.0,
    "cache_retention_time": 60.0
  }
}
```

**参数说明**：
- `dt_backend`：后端计算步长（秒），默认 0.2
- `T_total`：总仿真时长（秒）
  - `null` 或 `-1`：无限制持续运行
  - 正数：指定总时长
- `cache_retention_time`：缓存保留时间（秒），可选
  - `null`：保留所有帧
  - 正数：只保留最近 N 秒的帧

### 响应：

```json
{
  "simulation_id": "abcd-1234",
  "status": "running"
}
```

---

## **10.2 获取区域模拟结果帧（单时刻）**

`GET /api/query/simulation/{simulation_id}/frames?time={time}`

### 请求参数：
- `simulation_id`（路径参数）：模拟任务 ID
- `time`（查询参数，必填）：指定时间（秒），相对于 t=0 的偏移
  - `time=-1`：表示获取最新帧
  - 其他值：获取指定时刻的数据（系统会返回最接近该时刻的帧）

### 响应：

```json
{
  "simulation_id": "abcd-1234",
  "status": "running",
  "frames": [
    {
      "time": 0.2,
      "region": {...},
      "points": [
        { "lon": ..., "lat": ..., "wave_height": ... },
        ...
      ]
    }
  ]
}
```

**说明**：
- 接口每次只返回一个时刻的数据（单帧）
- 如需获取多个时刻的数据，需要多次调用接口并指定不同的 `time` 值
- 使用 `time=-1` 可以获取模拟任务的最新帧，适用于实时监控场景

---

## **10.3 单点查询**

`POST /api/query/point`

### 请求：

```json
{
  "simulation_id": "abcd-1234",
  "lon": 120.5,
  "lat": 35.2,
  "time": 0.6
}
```

**参数说明**：
- `time`：指定查询时刻（秒），相对于 t=0 的偏移
  - `time=-1`：表示查询最新帧的数据
  - 其他值：查询指定时刻的数据

### 响应：

```json
{
  "simulation_id": "abcd-1234",
  "time": 0.6,
  "lon": 120.5,
  "lat": 35.2,
  "wave_height": 1.23
}
```

**说明**：
- 响应中的 `time` 字段为实际查询的时间（如果请求中 `time=-1`，则返回最新帧的实际时间）
- 使用空间双线性插值和时间线性插值计算指定点的海浪高度

---

# **11. 后续规划（非本版本实现）**

* 支持 **时间变化风场**
* 支持 **空间非均匀风场**
* 接入外部风场数据（如数值天气预报）
* 实现完整 **JONSWAP** 模型并支持参数调节
* 引入海底地形真实 DEM
* 支持 GPU 加速

---

# **12. 附录：模型关系图（文字版）**

```
风场模型 → 波浪谱模型 → 波成分（频率×方向） → 叠加 → t=0 初始海浪场
        → 随时间推进（dt_backend） → 海浪高度场序列
```