# **时变海浪环境模型系统 - 需求文档（V1.0）**

## **文档信息**

* 文档版本：V1.0
* Applicable Version：初始版本
* 文档类型：需求说明（PRD + 技术需求综合）
* 作者：——
* 更新日期：——

---

# **1. 概述**

本系统旨在实现一个**时变海浪环境模型**，支持对指定区域内的海浪高度进行**模拟、查询与可视化展示**。系统采用**前后端分离架构**，后端负责海浪物理模型模拟与数据服务，前端负责参数配置、区域显示与动态渲染。

系统可用于：海上仿真系统、可视化演示、路径规划评估、无人系统模拟等场景。

---

# **2. 系统整体架构**

## **2.1 架构原则**

* **前后端分离**，降低耦合，提升拓展能力
* 后端提供统一 JSON API
* 前端负责展示、交互和参数管理
* 模型可扩展：风场模型、波浪谱模型可后续替换或升级

## **2.2 模块组成**

| 模块            | 主要职责                    |
| ------------- | ----------------------- |
| 后端服务（FastAPI） | 海浪模拟、区域计算、数据输出、点查询、参数管理 |
| 前端系统（Streamlit） | 区域可视化、参数配置、渲染控制、单点查询    |
| 风场模型模块        | 生成风速/风向，供谱模型使用          |
| 波浪谱模型模块       | 根据风场生成波浪谱参数，输出波成分       |
| 海浪场生成模块       | 根据谱叠加生成海浪高度场            |
| 插值模块          | 提供单点查询（双线性插值 + 时间插值）    |

## **2.3 技术栈**

### **后端技术栈**
- **框架**: FastAPI
- **语言**: Python 3.8
- **数据验证**: Pydantic
- **ASGI 服务器**: Uvicorn
- **数值计算**: NumPy

### **前端技术栈**
- **框架**: Streamlit
- **语言**: Python 3.8
- **可视化库**: Plotly / Matplotlib / Folium
- **HTTP 客户端**: httpx

### **通信方式**
- 前后端通过 HTTP REST API 通信
- 数据格式：JSON
- 后端服务地址：`http://localhost:8000`
- 前端服务地址：`http://localhost:8501`

---

# **3. 时间逻辑与仿真控制**

* 系统以**统一后端时间轴**进行仿真。
* `t = 0` 表示初始海况（初始风场 + 初始海浪场）。
* 后端计算时间步长 `dt_backend`：

  * 默认值：**200 ms**
  * 可配置
* 前端渲染时间步长 `dt_render`：

  * 与后端不同
  * 防止渲染卡顿
* 后端每隔一个 `dt_backend` 生成一帧海浪场，并可通过接口供前端按 `dt_render` 播放。

---

# **4. 后端核心功能需求**

## **4.1 区域模拟渲染**

### 输入

* 区域（矩形区域，由对角两点描述）：

```json
{
  "lon_min": ..., "lat_min": ..., "depth_min": ...,
  "lon_max": ..., "lat_max": ..., "depth_max": ...
}
```

* 风场模型参数（见第 6 章）
* 波浪谱模型参数（见第 7 章）
* 离散化参数（dx, dy, max_points）
* 时间参数（dt_backend, T_total）

### 初始状态

* 初始风场：固定风场（后续可扩展）
* 初始海浪场：

  * 初始海浪可随机生成，但**必须符合波浪谱统计规律**
  * 振幅由谱控制
  * 相位随机

### 模拟过程

* 将经纬度区域映射到网格；
* 由风场 → 生成光谱 → 叠加得海浪场；
* 每 `dt_backend` 推进一次海浪模拟；
* 生成 `[t0, t1, ..., tN]` 的海浪高度场序列。

### 输出（JSON）

每个时间帧：

```json
{
  "time": 0.2,
  "region": {...},
  "points": [
    { "lon": ..., "lat": ..., "wave_height": ... },
    ...
  ]
}
```

## **4.2 单点查询**

### 输入

```json
{
  "simulation_id": "...",
  "lon": 120.5,
  "lat": 35.2,
  "time": 0.4
}
```

### 插值逻辑

* 空间：**双线性插值**
* 时间：相邻时间帧间线性插值（必要时可先取最近一帧）

### 输出

```json
{
  "time": 0.4,
  "lon": 120.5,
  "lat": 35.2,
  "wave_height": 1.23
}
```

---

# **5. 前端功能需求**

## **5.1 区域模拟可视化**

* 显示矩形区域地图/网格
* 根据时间动态渲染海浪高度
* 支持 colorbar（颜色-浪高映射）

## **5.2 单点查询**

* 鼠标点击地图可自动发起点查询
* 支持手动输入经纬度进行查询
* 显示返回的当前浪高值

## **5.3 参数配置**

* 所有**可配置参数均在前端展示**
* 前端可修改并提交参数用于新一轮模拟
* 支持“基础模式”与“高级模式”

## **5.4 控制逻辑**

* **start** 按钮：根据当前参数启动仿真
* 前端按 `dt_render` 播放后端结果
* 用户可暂停/继续观看时间序列

---

# **6. 风场模型需求**

## **6.1 模型说明**

* 当前版本为：**固定风模型**
* 后续支持时间变化/空间变化风场
* 风场模型与波浪谱模型完全解耦，通过参数传递

## **6.2 可配置参数（全部前端可见）**

| 参数名                  | 默认值   | 说明        | 范围    | 显示到前端 |
| -------------------- | ----- | --------- | ----- | ----- |
| `wind_speed`         | 10.0  | 风速（m/s）   | 0–40  | 是     |
| `wind_direction_deg` | 270.0 | 风向（°，顺时针） | 0–360 | 是     |
| `reference_height_m` | 10.0  | 风速参考高度    | 固定    | 高级模式  |

> 注：
> 0° 指从北向南（可根据项目需求调整，但需保证固定定义）。

---

# **7. 波浪谱模型需求**

## **7.1 模型选择**

* 支持以下模型：

  * **Pierson-Moskowitz（PM）光谱（默认）**
  * **JONSWAP 光谱（后续版本实现）**

## **7.2 可配置参数**

### **通用参数（PM / JONSWAP 共用）**

| 参数名                       | 默认值  | 说明      | 范围               | 前端显示 |
| ------------------------- | ---- | ------- | ---------------- | ---- |
| `spectrum_model_type`     | "PM" | 光谱模型类型  | {"PM","JONSWAP"} | 是    |
| `Hs`                      | 2.0  | 显著波高（m） | 0–15             | 是    |
| `Tp`                      | 8.0  | 峰值周期（s） | 2–20             | 是    |
| `main_wave_direction_deg` | 同风向  | 主浪向     | 0–360            | 高级可选 |
| `directional_spread_deg`  | 30   | 波向扩散    | 5–90             | 高级可选 |

### **JONSWAP 专用参数（高级）**

| 参数名     | 默认值 | 说明   | 范围  | 前端显示 |
| ------- | --- | ---- | --- | ---- |
| `gamma` | 3.3 | 峰锐系数 | 1–7 | 高级模式 |

---

# **8. 数值与离散化需求**

* 输入输出使用**经纬度**；
* 中间计算过程可转换为本地平面网格 `(x, y)`；
* 空间离散参数：

  * `dx`、`dy`（单位：° 或 米），具体转换由后端定义；
  * `max_points`：空间离散点数上限；
* 时间离散参数：

  * `dt_backend`：后端计算步长；
  * `T_total`：总仿真时间；

---

# **9. 数据格式规范**

* **所有输入输出采用 JSON 格式**
* 坐标系：经纬度（WGS84），单位：度
* 深度单位：米（m）
* 波高单位：米（m）
* 时间单位：秒（s）

---

# **10. 后端接口（初版草案）**

## **10.1 发起区域模拟**

`POST /api/simulate/area`

### 请求：

```json
{
  "region": {...},
  "wind": {...},
  "spectrum": {...},
  "discretization": {"dx":0.01,"dy":0.01,"max_points":40000},
  "time": {"dt_backend":0.2,"T_total":10.0}
}
```

### 响应：

```json
{
  "simulation_id": "abcd-1234",
  "status": "running"
}
```

---

## **10.2 获取区域模拟结果**

`GET /api/simulation/{id}/frames`

```json
[
  { "time": 0.0, "points":[...] },
  { "time": 0.2, "points":[...] },
  ...
]
```

---

## **10.3 单点查询**

`POST /api/query/point`

### 请求：

```json
{
  "simulation_id": "abcd-1234",
  "lon": 120.5,
  "lat": 35.2,
  "time": 0.6
}
```

### 响应：

```json
{
  "time": 0.6,
  "lon": 120.5,
  "lat": 35.2,
  "wave_height": 1.23
}
```

---

# **11. 后续规划（非本版本实现）**

* 支持 **时间变化风场**
* 支持 **空间非均匀风场**
* 接入外部风场数据（如数值天气预报）
* 实现完整 **JONSWAP** 模型并支持参数调节
* 引入海底地形真实 DEM
* 支持 GPU 加速

---

# **12. 附录：模型关系图（文字版）**

```
风场模型 → 波浪谱模型 → 波成分（频率×方向） → 叠加 → t=0 初始海浪场
        → 随时间推进（dt_backend） → 海浪高度场序列
```