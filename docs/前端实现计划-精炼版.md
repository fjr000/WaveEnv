# Streamlit 前端实现计划（精炼版）

## 📋 实现目标

构建完整的 Streamlit 前端，实现参数配置、区域模拟可视化、单点查询和时间序列播放功能。

## 🏗️ 模块划分

### 1. API 客户端模块 (`frontend/utils/api_client.py`)

**职责**：封装后端 API 调用

**功能**：
- 创建 HTTP 客户端（httpx）
- 实现三个核心 API 调用：
  - `create_simulation()` - POST /api/simulate/area
  - `get_frames()` - GET /api/simulation/{id}/frames
  - `query_point()` - POST /api/query/point
- 统一错误处理和超时设置

### 2. 参数配置模块 (`frontend/app.py` - 侧边栏)

**职责**：提供参数输入界面

**功能**：
- **区域配置**：lon_min/max, lat_min/max, depth_min/max
- **风场参数**：wind_speed, wind_direction_deg, reference_height_m
- **波浪谱参数**：spectrum_model_type, Hs, Tp, main_wave_direction_deg, directional_spread_deg, gamma
- **离散化参数**：dx, dy, max_points
- **时间参数**：dt_backend, T_total
- 基础/高级模式切换（高级模式显示所有参数）
- 参数验证和默认值

### 3. 数据转换模块 (`frontend/utils/data_converter.py`)

**职责**：将 API 响应转换为可视化所需格式

**功能**：
- 将 `SimulationFrame` 列表转换为网格数据（lon_grid, lat_grid, height_grid）
- 提取时间序列数组
- 处理单点查询结果格式化

### 4. 可视化模块 (`frontend/utils/visualization.py`)

**职责**：生成可视化图表

**功能**：
- **热力图**：使用 Plotly 创建海浪高度场热力图
  - 输入：lon_grid, lat_grid, height_grid (单帧)
  - 输出：Plotly figure
- **时间序列图表**：显示特定点的海浪高度随时间变化
- **颜色映射**：配置 colorbar 和颜色方案

### 5. 主应用流程 (`frontend/app.py`)

**职责**：整合所有模块，实现完整交互流程

**布局结构**：
```
┌─────────────────────────────────────┐
│  标题栏                              │
├──────────┬──────────────────────────┤
│ 侧边栏   │  主内容区                  │
│          │                          │
│ 参数配置 │  ┌────────────────────┐  │
│ [开始]   │  │  可视化图表区域      │  │
│          │  │  (Plotly)          │  │
│          │  └────────────────────┘  │
│          │  ┌────────────────────┐  │
│          │  │  控制面板            │  │
│          │  │  [播放][暂停][重置] │  │
│          │  │  时间滑块            │  │
│          │  └────────────────────┘  │
│          │  ┌────────────────────┐  │
│          │  │  单点查询           │  │
│          │  │  坐标输入/结果显示  │  │
│          │  └────────────────────┘  │
└──────────┴──────────────────────────┘
```

**状态管理**（使用 `st.session_state`）：
- `simulation_id` - 当前模拟任务 ID
- `frames` - 模拟结果帧列表
- `current_time_idx` - 当前显示的时间帧索引
- `is_playing` - 播放状态
- `query_result` - 单点查询结果

**核心流程**：
1. 用户配置参数（侧边栏）
2. 点击"开始模拟"按钮
3. 调用 API 创建模拟任务，显示进度
4. 获取模拟结果帧
5. 初始化可视化（第一帧）
6. 提供播放控制（播放/暂停/时间滑块）
7. 支持单点查询（输入坐标或点击地图）

## 📝 实现步骤

### 阶段 1：基础框架
1. 创建 `utils/api_client.py` - 实现 API 客户端
2. 创建 `utils/data_converter.py` - 实现数据转换
3. 创建 `utils/visualization.py` - 实现可视化函数
4. 更新 `app.py` - 添加基础布局和导入

### 阶段 2：参数配置
1. 实现侧边栏参数配置界面
2. 添加基础/高级模式切换
3. 实现参数验证

### 阶段 3：模拟任务管理
1. 实现"开始模拟"按钮逻辑
2. 调用 API 创建任务，显示进度条
3. 获取模拟结果并存储到 session_state
4. 错误处理和状态提示

### 阶段 4：可视化实现
1. 实现数据转换（API 响应 → 网格数据）
2. 创建热力图组件
3. 实现时间序列播放（自动更新图表）
4. 添加 colorbar 和标题

### 阶段 5：交互控制
1. 实现播放/暂停按钮
2. 实现时间滑块（手动选择时间帧）
3. 实现重置功能
4. 优化播放速度控制

### 阶段 6：单点查询
1. 实现坐标输入界面
2. 调用查询 API
3. 显示查询结果
4. 可选：在地图上标记查询点

### 阶段 7：优化和测试
1. 性能优化（缓存、异步加载）
2. 用户体验优化（加载提示、错误提示）
3. 测试各种参数组合
4. 文档完善

## 🔧 技术要点

### 状态管理
- 使用 `st.session_state` 存储模拟结果和状态
- 避免重复调用 API（缓存结果）

### 异步处理
- API 调用使用 httpx 异步客户端
- 长时间任务显示进度条和状态

### 性能优化
- 使用 `@st.cache_data` 缓存 API 响应
- 大数据量时限制返回帧数（使用 max_frames 参数）
- 可视化时只渲染当前帧

### 错误处理
- API 调用失败时显示友好错误信息
- 参数验证失败时提示用户
- 网络连接问题处理

## 📦 文件结构

```
frontend/
├── app.py                    # 主应用文件
├── utils/
│   ├── api_client.py         # API 客户端
│   ├── data_converter.py     # 数据转换
│   └── visualization.py      # 可视化函数
├── requirements.txt
└── .streamlit/
    └── config.toml
```

## ✅ 验收标准

1. 能够配置所有参数并启动模拟
2. 能够显示海浪高度场热力图
3. 能够播放时间序列动画
4. 能够进行单点查询并显示结果
5. 界面友好，错误提示清晰
6. 性能良好，响应及时

---

**注意**：本计划为精炼版，具体实现细节在编码时补充。



